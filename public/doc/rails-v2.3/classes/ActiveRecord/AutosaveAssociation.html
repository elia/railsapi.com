<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
    <title>ActiveRecord::AutosaveAssociation</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <link rel="stylesheet" href="../../css/reset.css" type="text/css" media="screen" />
<link rel="stylesheet" href="../../css/main.css" type="text/css" media="screen" />
<link rel="stylesheet" href="../../css/github.css" type="text/css" media="screen" />
<script src="../../js/jquery-1.3.2.min.js" type="text/javascript" charset="utf-8"></script>
<script src="../../js/jquery-effect.js" type="text/javascript" charset="utf-8"></script>
<script src="../../js/main.js" type="text/javascript" charset="utf-8"></script>
<script src="../../js/highlight.pack.js" type="text/javascript" charset="utf-8"></script>

</head>

<body>     
    <div class="banner">
        
        <h1>
            <span class="type">Module</span> 
            ActiveRecord::AutosaveAssociation 
            
        </h1>
        <ul class="files">
            
            <li><a href="../../files/activerecord/lib/active_record/autosave_association_rb.html">activerecord/lib/active_record/autosave_association.rb</a></li>
            
        </ul>
    </div>
    <div id="bodyContent">
        <div id="content">
  
    <div class="description">
      
<p><a href="AutosaveAssociation.html">AutosaveAssociation</a> is a module that
takes care of automatically saving your associations when the parent is
saved. In addition to saving, it also destroys any associations that were
marked for destruction. (See <a
href="AutosaveAssociation.html#method-i-mark_for_destruction">#mark_for_destruction</a>
and marked_for_destruction?)</p>

<p>Saving of the parent, its associations, and the destruction of marked
associations, all happen inside 1 transaction. This should never leave the
database in an inconsistent state after, for instance, mass assigning
attributes and saving them.</p>

<p>If validations for any of the associations fail, their error messages will
be applied to the parent.</p>

<p>Note that it also means that associations marked for destruction won&#39;t
be destroyed directly. They will however still be marked for destruction.</p>

<h3 id="label-One-to-one+Example">One-to-one Example</h3>

<p>Consider a Post model with one Author:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">Post</span>
  <span class="ruby-identifier">has_one</span> :<span class="ruby-identifier">author</span>, :<span class="ruby-identifier">autosave</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword">true</span>
<span class="ruby-keyword">end</span>
</pre>

<p>Saving changes to the parent and its associated model can now be performed
automatically <em>and</em> atomically:</p>

<pre class="ruby"><span class="ruby-identifier">post</span> = <span class="ruby-constant">Post</span>.<span class="ruby-identifier">find</span>(<span class="ruby-value">1</span>)
<span class="ruby-identifier">post</span>.<span class="ruby-identifier">title</span> <span class="ruby-comment"># =&gt; &quot;The current global position of migrating ducks&quot;</span>
<span class="ruby-identifier">post</span>.<span class="ruby-identifier">author</span>.<span class="ruby-identifier">name</span> <span class="ruby-comment"># =&gt; &quot;alloy&quot;</span>

<span class="ruby-identifier">post</span>.<span class="ruby-identifier">title</span> = <span class="ruby-string">&quot;On the migration of ducks&quot;</span>
<span class="ruby-identifier">post</span>.<span class="ruby-identifier">author</span>.<span class="ruby-identifier">name</span> = <span class="ruby-string">&quot;Eloy Duran&quot;</span>

<span class="ruby-identifier">post</span>.<span class="ruby-identifier">save</span>
<span class="ruby-identifier">post</span>.<span class="ruby-identifier">reload</span>
<span class="ruby-identifier">post</span>.<span class="ruby-identifier">title</span> <span class="ruby-comment"># =&gt; &quot;On the migration of ducks&quot;</span>
<span class="ruby-identifier">post</span>.<span class="ruby-identifier">author</span>.<span class="ruby-identifier">name</span> <span class="ruby-comment"># =&gt; &quot;Eloy Duran&quot;</span>
</pre>

<p>Destroying an associated model, as part of the parent&#39;s save action, is
as simple as marking it for destruction:</p>

<pre class="ruby"><span class="ruby-identifier">post</span>.<span class="ruby-identifier">author</span>.<span class="ruby-identifier">mark_for_destruction</span>
<span class="ruby-identifier">post</span>.<span class="ruby-identifier">author</span>.<span class="ruby-identifier">marked_for_destruction?</span> <span class="ruby-comment"># =&gt; true</span>
</pre>

<p>Note that the model is <em>not</em> yet removed from the database:</p>

<pre class="ruby"><span class="ruby-identifier">id</span> = <span class="ruby-identifier">post</span>.<span class="ruby-identifier">author</span>.<span class="ruby-identifier">id</span>
<span class="ruby-constant">Author</span>.<span class="ruby-identifier">find_by_id</span>(<span class="ruby-identifier">id</span>).<span class="ruby-identifier">nil?</span> <span class="ruby-comment"># =&gt; false</span>

<span class="ruby-identifier">post</span>.<span class="ruby-identifier">save</span>
<span class="ruby-identifier">post</span>.<span class="ruby-identifier">reload</span>.<span class="ruby-identifier">author</span> <span class="ruby-comment"># =&gt; nil</span>
</pre>

<p>Now it <em>is</em> removed from the database:</p>

<pre class="ruby"><span class="ruby-constant">Author</span>.<span class="ruby-identifier">find_by_id</span>(<span class="ruby-identifier">id</span>).<span class="ruby-identifier">nil?</span> <span class="ruby-comment"># =&gt; true</span>
</pre>

<h3 id="label-One-to-many+Example">One-to-many Example</h3>

<p>Consider a Post model with many Comments:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">Post</span>
  <span class="ruby-identifier">has_many</span> :<span class="ruby-identifier">comments</span>, :<span class="ruby-identifier">autosave</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword">true</span>
<span class="ruby-keyword">end</span>
</pre>

<p>Saving changes to the parent and its associated model can now be performed
automatically <em>and</em> atomically:</p>

<pre class="ruby"><span class="ruby-identifier">post</span> = <span class="ruby-constant">Post</span>.<span class="ruby-identifier">find</span>(<span class="ruby-value">1</span>)
<span class="ruby-identifier">post</span>.<span class="ruby-identifier">title</span> <span class="ruby-comment"># =&gt; &quot;The current global position of migrating ducks&quot;</span>
<span class="ruby-identifier">post</span>.<span class="ruby-identifier">comments</span>.<span class="ruby-identifier">first</span>.<span class="ruby-identifier">body</span> <span class="ruby-comment"># =&gt; &quot;Wow, awesome info thanks!&quot;</span>
<span class="ruby-identifier">post</span>.<span class="ruby-identifier">comments</span>.<span class="ruby-identifier">last</span>.<span class="ruby-identifier">body</span> <span class="ruby-comment"># =&gt; &quot;Actually, your article should be named differently.&quot;</span>

<span class="ruby-identifier">post</span>.<span class="ruby-identifier">title</span> = <span class="ruby-string">&quot;On the migration of ducks&quot;</span>
<span class="ruby-identifier">post</span>.<span class="ruby-identifier">comments</span>.<span class="ruby-identifier">last</span>.<span class="ruby-identifier">body</span> = <span class="ruby-string">&quot;Actually, your article should be named differently. [UPDATED]: You are right, thanks.&quot;</span>

<span class="ruby-identifier">post</span>.<span class="ruby-identifier">save</span>
<span class="ruby-identifier">post</span>.<span class="ruby-identifier">reload</span>
<span class="ruby-identifier">post</span>.<span class="ruby-identifier">title</span> <span class="ruby-comment"># =&gt; &quot;On the migration of ducks&quot;</span>
<span class="ruby-identifier">post</span>.<span class="ruby-identifier">comments</span>.<span class="ruby-identifier">last</span>.<span class="ruby-identifier">body</span> <span class="ruby-comment"># =&gt; &quot;Actually, your article should be named differently. [UPDATED]: You are right, thanks.&quot;</span>
</pre>

<p>Destroying one of the associated models members, as part of the
parent&#39;s save action, is as simple as marking it for destruction:</p>

<pre class="ruby"><span class="ruby-identifier">post</span>.<span class="ruby-identifier">comments</span>.<span class="ruby-identifier">last</span>.<span class="ruby-identifier">mark_for_destruction</span>
<span class="ruby-identifier">post</span>.<span class="ruby-identifier">comments</span>.<span class="ruby-identifier">last</span>.<span class="ruby-identifier">marked_for_destruction?</span> <span class="ruby-comment"># =&gt; true</span>
<span class="ruby-identifier">post</span>.<span class="ruby-identifier">comments</span>.<span class="ruby-identifier">length</span> <span class="ruby-comment"># =&gt; 2</span>
</pre>

<p>Note that the model is <em>not</em> yet removed from the database:</p>

<pre class="ruby"><span class="ruby-identifier">id</span> = <span class="ruby-identifier">post</span>.<span class="ruby-identifier">comments</span>.<span class="ruby-identifier">last</span>.<span class="ruby-identifier">id</span>
<span class="ruby-constant">Comment</span>.<span class="ruby-identifier">find_by_id</span>(<span class="ruby-identifier">id</span>).<span class="ruby-identifier">nil?</span> <span class="ruby-comment"># =&gt; false</span>

<span class="ruby-identifier">post</span>.<span class="ruby-identifier">save</span>
<span class="ruby-identifier">post</span>.<span class="ruby-identifier">reload</span>.<span class="ruby-identifier">comments</span>.<span class="ruby-identifier">length</span> <span class="ruby-comment"># =&gt; 1</span>
</pre>

<p>Now it <em>is</em> removed from the database:</p>

<pre class="ruby"><span class="ruby-constant">Comment</span>.<span class="ruby-identifier">find_by_id</span>(<span class="ruby-identifier">id</span>).<span class="ruby-identifier">nil?</span> <span class="ruby-comment"># =&gt; true</span>
</pre>

<h3 id="label-Validation">Validation</h3>

<p>Validation is performed on the parent as usual, but also on all autosave
enabled associations. If any of the associations fail validation, its error
messages will be applied on the parents errors object and validation of the
parent will fail.</p>

<p>Consider a Post model with Author which validates the presence of its name
attribute:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">Post</span>
  <span class="ruby-identifier">has_one</span> :<span class="ruby-identifier">author</span>, :<span class="ruby-identifier">autosave</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword">true</span>
<span class="ruby-keyword">end</span>

<span class="ruby-keyword">class</span> <span class="ruby-constant">Author</span>
  <span class="ruby-identifier">validates_presence_of</span> :<span class="ruby-identifier">name</span>
<span class="ruby-keyword">end</span>

<span class="ruby-identifier">post</span> = <span class="ruby-constant">Post</span>.<span class="ruby-identifier">find</span>(<span class="ruby-value">1</span>)
<span class="ruby-identifier">post</span>.<span class="ruby-identifier">author</span>.<span class="ruby-identifier">name</span> = <span class="ruby-string">&#39;&#39;</span>
<span class="ruby-identifier">post</span>.<span class="ruby-identifier">save</span> <span class="ruby-comment"># =&gt; false</span>
<span class="ruby-identifier">post</span>.<span class="ruby-identifier">errors</span> <span class="ruby-comment"># =&gt; #&lt;ActiveRecord::Errors:0x174498c @errors={&quot;author_name&quot;=&gt;[&quot;can&#39;t be blank&quot;]}, @base=#&lt;Post ...&gt;&gt;</span>
</pre>

<p>No validations will be performed on the associated models when validations
are skipped for the parent:</p>

<pre class="ruby"><span class="ruby-identifier">post</span> = <span class="ruby-constant">Post</span>.<span class="ruby-identifier">find</span>(<span class="ruby-value">1</span>)
<span class="ruby-identifier">post</span>.<span class="ruby-identifier">author</span>.<span class="ruby-identifier">name</span> = <span class="ruby-string">&#39;&#39;</span>
<span class="ruby-identifier">post</span>.<span class="ruby-identifier">save</span>(<span class="ruby-keyword">false</span>) <span class="ruby-comment"># =&gt; true</span>
</pre>

    </div>
  


  


  
  


  
    <!-- Namespace -->
    <div class="sectiontitle">Namespace</div>
    <ul>
      
        <li>
          <span class="type">MODULE</span>
          <a href="AutosaveAssociation/ClassMethods.html">ActiveRecord::AutosaveAssociation::ClassMethods</a>
        </li>
      
    </ul>
  


  
    <!-- Method ref -->
    <div class="sectiontitle">Methods</div>
    <dl class="methods">
      
        <dt>C</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-changed_for_autosave-3F">changed_for_autosave?</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>I</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-c-included">included</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>M</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-mark_for_destruction">mark_for_destruction</a>,
              </li>
            
              
              <li>
                <a href="#method-i-marked_for_destruction-3F">marked_for_destruction?</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>R</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-reload_with_autosave_associations">reload_with_autosave_associations</a>
              </li>
            
          </ul>
        </dd>
      
    </dl>
  

  



  

    

    

    
      <!-- Section constants -->
      <div class="sectiontitle">Constants</div>
      <table border='0' cellpadding='5'>
        
          <tr valign='top'>
            <td class="attr-name">ASSOCIATION_TYPES</td>
            <td>=</td>
            <td class="attr-value">%w{ has_one belongs_to has_many has_and_belongs_to_many }</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"></td>
            </tr>
          
        
      </table>
    


    


    <!-- Methods -->
    
      <div class="sectiontitle">Class Public methods</div>
      
        <div class="method">
          <div class="title method-title" id="method-c-included">
            
              <b>included</b>(base)
            
            <a href="../../classes/ActiveRecord/AutosaveAssociation.html#method-c-included" name="method-c-included" class="permalink">Link</a>
          </div>
          
          
            <div class="description">
              
            </div>
          
          
          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-c-included_source')" id="l_method-c-included_source">show</a>
                
              </p>
              <div id="method-c-included_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/lib/active_record/autosave_association.rb, line 130</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">self</span>.<span class="ruby-identifier">included</span>(<span class="ruby-identifier">base</span>)
  <span class="ruby-identifier">base</span>.<span class="ruby-identifier">class_eval</span> <span class="ruby-keyword">do</span>
    <span class="ruby-identifier">base</span>.<span class="ruby-identifier">extend</span>(<span class="ruby-constant">ClassMethods</span>)
    <span class="ruby-identifier">alias_method_chain</span> <span class="ruby-value">:reload</span>, <span class="ruby-value">:autosave_associations</span>

    <span class="ruby-constant">ASSOCIATION_TYPES</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">type</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">base</span>.<span class="ruby-identifier">send</span>(<span class="ruby-node">&quot;valid_keys_for_#{type}_association&quot;</span>) <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value">:autosave</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
                  
      <div class="sectiontitle">Instance Public methods</div>
      
        <div class="method">
          <div class="title method-title" id="method-i-changed_for_autosave-3F">
            
              <b>changed_for_autosave?</b>()
            
            <a href="../../classes/ActiveRecord/AutosaveAssociation.html#method-i-changed_for_autosave-3F" name="method-i-changed_for_autosave-3F" class="permalink">Link</a>
          </div>
          
          
            <div class="description">
              <p>Returns whether or not this record has been changed in any way (including
whether any of its nested autosave associations are likewise changed)</p>
            </div>
          
          
          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-changed_for_autosave-3F_source')" id="l_method-i-changed_for_autosave-3F_source">show</a>
                
              </p>
              <div id="method-i-changed_for_autosave-3F_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/lib/active_record/autosave_association.rb, line 222</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">changed_for_autosave?</span>
  <span class="ruby-identifier">new_record?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">changed?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">marked_for_destruction?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">nested_records_changed_for_autosave?</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-mark_for_destruction">
            
              <b>mark_for_destruction</b>()
            
            <a href="../../classes/ActiveRecord/AutosaveAssociation.html#method-i-mark_for_destruction" name="method-i-mark_for_destruction" class="permalink">Link</a>
          </div>
          
          
            <div class="description">
              <p>Marks this record to be destroyed as part of the parents save transaction.
This does <em>not</em> actually destroy the record yet, rather it will be
destroyed when <code>parent.save</code> is called.</p>

<p>Only useful if the <code>:autosave</code> option on the parent is enabled
for this associated model.</p>
            </div>
          
          
          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-mark_for_destruction_source')" id="l_method-i-mark_for_destruction_source">show</a>
                
              </p>
              <div id="method-i-mark_for_destruction_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/lib/active_record/autosave_association.rb, line 209</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">mark_for_destruction</span>
  <span class="ruby-ivar">@marked_for_destruction</span> = <span class="ruby-keyword">true</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-marked_for_destruction-3F">
            
              <b>marked_for_destruction?</b>()
            
            <a href="../../classes/ActiveRecord/AutosaveAssociation.html#method-i-marked_for_destruction-3F" name="method-i-marked_for_destruction-3F" class="permalink">Link</a>
          </div>
          
          
            <div class="description">
              <p>Returns whether or not this record will be destroyed as part of the parents
save transaction.</p>

<p>Only useful if the <code>:autosave</code> option on the parent is enabled
for this associated model.</p>
            </div>
          
          
          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-marked_for_destruction-3F_source')" id="l_method-i-marked_for_destruction-3F_source">show</a>
                
              </p>
              <div id="method-i-marked_for_destruction-3F_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/lib/active_record/autosave_association.rb, line 216</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">marked_for_destruction?</span>
  <span class="ruby-ivar">@marked_for_destruction</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-reload_with_autosave_associations">
            
              <b>reload_with_autosave_associations</b>(options = nil)
            
            <a href="../../classes/ActiveRecord/AutosaveAssociation.html#method-i-reload_with_autosave_associations" name="method-i-reload_with_autosave_associations" class="permalink">Link</a>
          </div>
          
          
            <div class="description">
              <p>Reloads the attributes of the object as usual and removes a mark for
destruction.</p>
            </div>
          
          
          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-reload_with_autosave_associations_source')" id="l_method-i-reload_with_autosave_associations_source">show</a>
                
              </p>
              <div id="method-i-reload_with_autosave_associations_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/lib/active_record/autosave_association.rb, line 200</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">reload_with_autosave_associations</span>(<span class="ruby-identifier">options</span> = <span class="ruby-keyword">nil</span>)
  <span class="ruby-ivar">@marked_for_destruction</span> = <span class="ruby-keyword">false</span>
  <span class="ruby-identifier">reload_without_autosave_associations</span>(<span class="ruby-identifier">options</span>)
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
                    </div>

    </div>
  </body>
</html>    