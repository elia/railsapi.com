<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
    <title>ActiveRecord::Batches::ClassMethods</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <link rel="stylesheet" href="../../../css/reset.css" type="text/css" media="screen" />
<link rel="stylesheet" href="../../../css/main.css" type="text/css" media="screen" />
<link rel="stylesheet" href="../../../css/github.css" type="text/css" media="screen" />
<script src="../../../js/jquery-1.3.2.min.js" type="text/javascript" charset="utf-8"></script>
<script src="../../../js/jquery-effect.js" type="text/javascript" charset="utf-8"></script>
<script src="../../../js/main.js" type="text/javascript" charset="utf-8"></script>
<script src="../../../js/highlight.pack.js" type="text/javascript" charset="utf-8"></script>

</head>

<body>     
    <div class="banner">
        
        <h1>
            <span class="type">Module</span> 
            ActiveRecord::Batches::ClassMethods 
            
        </h1>
        <ul class="files">
            
            <li><a href="../../../files/activerecord/lib/active_record/batches_rb.html">activerecord/lib/active_record/batches.rb</a></li>
            
        </ul>
    </div>
    <div id="bodyContent">
        <div id="content">
  
    <div class="description">
      
<p>When processing large numbers of records, it&#39;s often a good idea to do
so in batches to prevent memory ballooning.</p>

    </div>
  


  


  
  


  


  
    <!-- Method ref -->
    <div class="sectiontitle">Methods</div>
    <dl class="methods">
      
        <dt>F</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-find_each">find_each</a>,
              </li>
            
              
              <li>
                <a href="#method-i-find_in_batches">find_in_batches</a>
              </li>
            
          </ul>
        </dd>
      
    </dl>
  

  



  

    

    

    


    


    <!-- Methods -->
        
      <div class="sectiontitle">Instance Public methods</div>
      
        <div class="method">
          <div class="title method-title" id="method-i-find_each">
            
              <b>find_each</b>(options = {})
            
            <a href="../../../classes/ActiveRecord/Batches/ClassMethods.html#method-i-find_each" name="method-i-find_each" class="permalink">Link</a>
          </div>
          
          
            <div class="description">
              <p>Yields each record that was found by the find <code>options</code>. The
find is performed by <a
href="ClassMethods.html#method-i-find_in_batches">#find_in_batches</a> with
a batch size of 1000 (or as specified by the <code>:batch_size</code>
option).</p>

<p>Example:</p>

<pre class="ruby"><span class="ruby-constant">Person</span>.<span class="ruby-identifier">find_each</span>(:<span class="ruby-identifier">conditions</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&quot;age &gt; 21&quot;</span>) <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">person</span><span class="ruby-operator">|</span>
  <span class="ruby-identifier">person</span>.<span class="ruby-identifier">party_all_night!</span>
<span class="ruby-keyword">end</span>
</pre>

<p>Note: This method is only intended to use for batch processing of large
amounts of records that wouldn&#39;t fit in memory all at once. If you just
need to loop over less than 1000 records, it&#39;s probably better just to
use the regular find methods.</p>
            </div>
          
          
          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-find_each_source')" id="l_method-i-find_each_source">show</a>
                
              </p>
              <div id="method-i-find_each_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/lib/active_record/batches.rb, line 24</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">find_each</span>(<span class="ruby-identifier">options</span> = {})
  <span class="ruby-identifier">find_in_batches</span>(<span class="ruby-identifier">options</span>) <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">records</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">records</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">record</span><span class="ruby-operator">|</span> <span class="ruby-keyword">yield</span> <span class="ruby-identifier">record</span> }
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">self</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-find_in_batches">
            
              <b>find_in_batches</b>(options = {})
            
            <a href="../../../classes/ActiveRecord/Batches/ClassMethods.html#method-i-find_in_batches" name="method-i-find_in_batches" class="permalink">Link</a>
          </div>
          
          
            <div class="description">
              <p>Yields each batch of records that was found by the find
<code>options</code> as an array. The size of each batch is set by the
<code>:batch_size</code> option; the default is 1000.</p>

<p>You can control the starting point for the batch processing by supplying
the <code>:start</code> option. This is especially useful if you want
multiple workers dealing with the same processing queue. You can make
worker 1 handle all the records between id 0 and 10,000 and worker 2 handle
from 10,000 and beyond (by setting the <code>:start</code> option on that
worker).</p>

<p>It&#39;s not possible to set the order. That is automatically set to
ascending on the primary key (“id ASC”) to make the batch ordering work.
This also mean that this method only works with integer-based primary keys.
You can&#39;t set the limit either, that&#39;s used to control the the
batch sizes.</p>

<p>Example:</p>

<pre class="ruby"><span class="ruby-constant">Person</span>.<span class="ruby-identifier">find_in_batches</span>(:<span class="ruby-identifier">conditions</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&quot;age &gt; 21&quot;</span>) <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">group</span><span class="ruby-operator">|</span>
  <span class="ruby-identifier">sleep</span>(<span class="ruby-value">50</span>) <span class="ruby-comment"># Make sure it doesn&#39;t get too crowded in there!</span>
  <span class="ruby-identifier">group</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">person</span><span class="ruby-operator">|</span> <span class="ruby-identifier">person</span>.<span class="ruby-identifier">party_all_night!</span> }
<span class="ruby-keyword">end</span>
</pre>
            </div>
          
          
          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-find_in_batches_source')" id="l_method-i-find_in_batches_source">show</a>
                
              </p>
              <div id="method-i-find_in_batches_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/lib/active_record/batches.rb, line 55</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">find_in_batches</span>(<span class="ruby-identifier">options</span> = {})
  <span class="ruby-identifier">raise</span> <span class="ruby-node">&quot;You can&#39;t specify an order, it&#39;s forced to be #{batch_order}&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:order</span>]
  <span class="ruby-identifier">raise</span> <span class="ruby-string">&quot;You can&#39;t specify a limit, it&#39;s forced to be the batch_size&quot;</span>  <span class="ruby-keyword">if</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:limit</span>]

  <span class="ruby-identifier">start</span> = <span class="ruby-identifier">options</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-value">:start</span>).<span class="ruby-identifier">to_i</span>
  <span class="ruby-identifier">batch_size</span> = <span class="ruby-identifier">options</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-value">:batch_size</span>) <span class="ruby-operator">||</span> <span class="ruby-number">1000</span>

  <span class="ruby-identifier">proxy</span> = <span class="ruby-identifier">scoped</span>(<span class="ruby-identifier">options</span>.<span class="ruby-identifier">merge</span>(<span class="ruby-value">:order</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">batch_order</span>, <span class="ruby-value">:limit</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">batch_size</span>))
  <span class="ruby-identifier">records</span> = <span class="ruby-identifier">proxy</span>.<span class="ruby-identifier">find</span>(<span class="ruby-value">:all</span>, <span class="ruby-value">:conditions</span> =<span class="ruby-operator">&gt;</span> [ <span class="ruby-node">&quot;#{table_name}.#{primary_key} &gt;= ?&quot;</span>, <span class="ruby-identifier">start</span> ])

  <span class="ruby-keyword">while</span> <span class="ruby-identifier">records</span>.<span class="ruby-identifier">any?</span>
    <span class="ruby-keyword">yield</span> <span class="ruby-identifier">records</span>

    <span class="ruby-keyword">break</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">records</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">&lt;</span> <span class="ruby-identifier">batch_size</span>
    
    <span class="ruby-identifier">last_value</span> = <span class="ruby-identifier">records</span>.<span class="ruby-identifier">last</span>.<span class="ruby-identifier">id</span>
    
    <span class="ruby-identifier">raise</span> <span class="ruby-string">&quot;You must include the primary key if you define a select&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">last_value</span>.<span class="ruby-identifier">present?</span>
    
    <span class="ruby-identifier">records</span> = <span class="ruby-identifier">proxy</span>.<span class="ruby-identifier">find</span>(<span class="ruby-value">:all</span>, <span class="ruby-value">:conditions</span> =<span class="ruby-operator">&gt;</span> [ <span class="ruby-node">&quot;#{table_name}.#{primary_key} &gt; ?&quot;</span>, <span class="ruby-identifier">last_value</span> ])
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
                    </div>

    </div>
  </body>
</html>    